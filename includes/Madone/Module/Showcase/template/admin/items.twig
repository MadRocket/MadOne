{% import 'macros.twig' as common %}

<h1>{{section.title}}</h1>
<div class="module-header"><a href="../">вернуться к списку разделов</a></div>

<div class="module-buttons">
	<button class="create-unit btn primary">Добавить позицию</button>
</div>


<div class="module-content">

	<div class="createFormPlace"></div>
	
	<div class="a-units sortable" stormModel="Model_Showcaseitem">
	
	{% for item in items %}
	<div class="a-unit" id="id-{{item.id}}">
	<div class="a-unit-body{{ item.enabled ? '' : ' disabled' }}" stormObject="{{item.id}}">
		<div class="actions">
			<img title="Открыть список изображений" class="image-list" width="16" height="16" src="/static/i/admin/icons/16/image.png"/>
			<img title="Редактировать" class="edit" width="16" height="16" src="/static/i/admin/icons/16/pencil.png"/>
			<img title="Включить/Выключить" class="enabled" stormField="enabled" width="16" height="16" src="/static/i/admin/icons/16/lamp-{{ item.enabled ? 'on' : 'off' }}.png"/>
			<img title="Удалить" class="delete" width="16" height="16" src="/static/i/admin/icons/16/cross.png"/>
		</div>
		<h2 stormText="title">{{ item.title }}</h2>
		<p stormText="price">{{ item.price }}</p>
	</div>
	</div>
	{% endfor %}
</div>

{{ common.pager(paginator) }}
</div>

<form id="item-form" class="a-unit-form form-stacked">
	<div class="clearfix">
	    <label>Название:</label>
	    <div class="input">
	        <input class="span11" type="text" name="title"/>
        </div>
    </div>
	<div class="clearfix">
	    <label>Цена:</label>
	    <div class="input">
	        <input class="span11" type="text" name="price"/>
        </div>
    </div>
    <div class="clearfix">
        <label></label>
        <div class="input">
            <ul class="inputs-list">
                <li>
                    <label>
                        <input type="checkbox" name="special" value="1" />
                        <span>Хит продаж / спецпредложение</span>
                    </label>
                </li>
            </ul>
        </div>
    </div>
	<div class="clearfix">
	    <label>Краткое описание:</label>
        <div class="input">
            <textarea class="span11" name="short_description"></textarea>
        </div>
    </div>
	<div class="clearfix">
	    <label>Полное описание:</label>
	    <div class="input">
	        <textarea rich="yes" class="span11" name="description"></textarea>
        </div>
    </div>

	<div class="actions">
		<button class="submit btn primary">Сохранить</button>
		<button class="cancel btn">Отмена</button>
	</div>
</form>

<div class="a-unit" id="item-template" style="display:none;">
	<div class="a-unit-body">
        <div class="actions">
			<img title="Открыть список изображений" class="image-list" width="16" height="16" src="/static/i/admin/icons/16/image.png"/>
			<img title="Редактировать" class="edit" width="16" height="16" src="/static/i/admin/icons/16/pencil.png"/>
			<img title="Включить/Выключить" class="enabled" stormField="enabled" width="16" height="16" src="/static/i/admin/icons/16/lamp-on.png"/>
			<img title="Удалить" class="delete" width="16" height="16" src="/static/i/admin/icons/16/cross.png"/>
        </div>
        <h2 stormText="title">Название позиции</h2>
        <p stormText="price">Цена, руб</p>
    </div>
</div>

<script type="text/javascript">

$( function() {
    $(".a-units").sortable({
		helper: 'clone',
		placeholder: 'ui-sortable-placeholder',
		forcePlaceholderSize: true,
		stop: function(event, ui) {
			var objects = {};

            $.each( $(".a-units").sortable( 'toArray' ), function( i, n ) {
                var id = n.split( '-' );
                try {
		              objects[ parseInt( id[1] ) ] = { position: i + 1 };
                } catch( e ) { };
            });

			$.post( "/admin/Model_ShowcaseItem/update/", { objects: JSON.stringify( objects ) }, function( r ) {
		        if( ! r.success ) {
		            alert( r.message );
		        }
	    	}, 'json' );
		}
	});

	$( '.enabled' ).click( function( e ) {
		Storm.toggle( Storm.buildPath( this ), Function.delegate( this, function( data ) {
			if(data.enabled) {
				$( this ).parents('.a-unit-body:first').removeClass('disabled');
				$( this ).attr( 'src', '/static/i/admin/icons/16/lamp-on.png');
			}
			else {
				$( this ).parents('.a-unit-body:first').addClass('disabled');			
				$( this ).attr( 'src', '/static/i/admin/icons/16/lamp-off.png' );
			}	
		} ) );
	} );
	
	$( '.delete' ).click( function( e ) {
		if( confirm( 'Вы действительно хотите удалить позицию «' + $( this ).parents( '.a-unit-body' ).find( 'h2' ).text() + '»?' ) ) {
			Storm.remove( Storm.buildPath( this ), Function.delegate( this, function() {
				$( this ).parents( '.a-unit' ).remove()
			} ) );
		}
	} );
	
	var itemForm = Object.create( Storm.Form ).extend( {
		form: $( '#item-form' ),
		onFetchData: function( form, data ) {
			data.section = {{ section.id }};
			data.price = parseInt( data.price );
			if( isNaN( data.price ) ) {
				data.price = null;
			}
		},
		onFillItem: function ( item, data ) {
			item.find( 'img.enabled' ).attr( 'src', data.enabled ? '/static/i/admin/icons/16/lamp-on.png' : '/static/i/admin/icons/16/lamp-off.png' );
			if( ! data.enabled ) {
				item.find( '.a-unit-body' ).addClass( 'disabled' );
			}
			item.attr( 'stormObject', data.id );
			item.attr( 'id', 'a-unit-' + data.id );
		}
	} );
	
	$( '.create-unit' ).click( function( e ) {
		e.preventDefault();
		Object.create( itemForm ).extend( {
			object: 'Model_Showcaseitem',
			formPlace: $( '.createFormPlace' ),
			item: $( '#item-template' ),
			itemPlace: $( '.a-units' )
		} ).start();
	} );

	$( '.edit' ).click( function( e ) {
		Object.create( itemForm ).extend( {
			object: Storm.buildPath( this ),
			item: $( this ).parents( '.a-unit-body' )
		} ).start();
	} );
	
    // Отображение нашей непростой формы списка изображений :)
    $( '.image-list' ).bind( 'click', function( event ) {
		Object.create( Madone.ImageGallery ).extend({
			stormModel: 'Model_Showcaseimage',
			PHPSESSID: '{{ sessid }}',
			object:	Storm.buildPath( this ),
			item:	$( this ).parents( '.a-unit-body' )
		}).start();
    } );

});

</script>
