<h1>Структура сайта</h1>
<div class="module-buttons">
    <button class="create-page btn primary">Создать страницу</button>
</div>
<div class="module-content">
    <div class="createFormPlace"></div>

    <div class="a-units sortable" stormModel="Model_Page">
        {{ _self.pageitem(root, false) }}

        <ol id="pages">
        {% for item in items %}
            {{ _self.pageitem(item, true) }}
        {% endfor %}
        <ol>
    </div>
</div>

{% macro pageitem(item, full) %}
    <li class="a-unit{{ item.enabled ? '' : ' disabled' }}" stormObject="{{ item.id }}" id="a-unit-{{ item.id }}">
           <div class="a-unit-body">
               <div class="actions">
                   <img class="actions__button edit" src="/static/i/admin/1x1.gif"/>
                   <img class="actions__button enabled{{ item.enabled ? '' : ' enabled_off' }}" stormField="enabled" src="/static/i/admin/1x1.gif"/>
                   <img class="actions__button menu{{ item.menu ? '' : ' menu_off' }}" stormField="menu" src="/static/i/admin/1x1.gif"/>
                   <img class="actions__button delete" src="/static/i/admin/1x1.gif"/>
               </div>
               <h2><a class="editlink" stormText="title" href="/admin/{{ item.module }}/{{ item.id }}">{{ item.title }}</a></h2>
               <p><a class="directlink" stormText="name" href="{{ item.uri }}">{{ item.name }}</a></p>
           </div>
           {% if full %}
           <ol>
                {% for child in item.getChildren() %}
                    {{ _self.pageitem(child, full) }}
                {% endfor %}
           </ol>
           {% endif %}
       </li>
{% endmacro %}

<form id="page-form" class="a-unit-form form-stacked" method="post" enctype="multipart/form-data">
    <ul class="tabs">
        <li class="active"><a href="#primary">Основные поля</a></li>
        <li><a href="#seo">SEO-поля</a></li>
    </ul>

    <div class="m-tab m-tab-active tab-primary">
        <div class="clearfix">
            <label>Название страницы</label>
            <div class="input">
                <input class="span11" size="30" type="text" name="title">
            </div>
        </div>
        <div class="clearfix">
            <label>Название по-английски</label>
            <div class="input">
                <input class="span11" size="30" type="text" name="name">
                <span class="help-block">для адресной строки</span>
            </div>
        </div>

        <div class="clearfix" style="display: none">
            <label>Тип страницы:</label>
            <div class="input">
                <select name="type">
                {% for type in types %}
                <option value="{{ type.id }}">{{ type.title }}</option>
                {% endfor %}
                </select>
            </div>
        </div>

        <div class="clearfix">
            <label>Модуль:</label>
            <div class="input">
                <select name="module">
                {% for module in modules %}
                <option value="{{ module.name }}">{{ module.title }}</option>
                {% endfor %}
                </select>
            </div>
        </div>

        <div class="clearfix">
            <label>Текст страницы:</label>
            <div class="input"><textarea name="text" rich="yes"></textarea></div>
        </div>
    </div>
    <div class="m-tab tab-seo">
        <div class="clearfix">
            <label>Заголовок:</label>
            <div class="input">
                <input class="span11" size="30" type="text" name="meta_title">
                <span class="help-block">Заголовок страницы</span>
            </div>
        </div>
        <div class="clearfix">
            <label>Ключевые слова:</label>
            <div class="input">
                <textarea class="span11" name="meta_keywords" wrap="wrap"></textarea>
                <span class="help-block">Ключевые слова стрницы, meta-тэг keywords</span>
            </div>
        </div>
        <div class="clearfix">
            <label>Описание:</label>
            <div class="input">
                <textarea class="span11" name="meta_description" wrap="wrap"></textarea>
                <span class="help-block">Описание стрницы, meta-тэг description</span>
            </div>
        </div>
    </div>

    <div class="block actions">
        <button class="submit btn primary" type="submit">Сохранить</button>
        <button class="cancel btn" type="reset">Отмена</button>
    </div>
</form>

<li class="a-unit" id="page-template" style="display:none;">
    <div class="a-unit-body">
        <div class="actions">
            <img class="actions__button edit" src="/static/i/admin/1x1.gif"/>
            <img class="actions__button enabled" stormField="enabled" src="/static/i/admin/1x1.gif"/>
            <img class="actions__button menu" stormField="menu" src="/static/i/admin/1x1.gif"/>
            <img class="actions__button delete" src="/static/i/admin/1x1.gif"/>
        </div>
        <h2><a class="editlink" href="" stormText="title"></a></h2>
        <p><a class="directlink" href="" stormText="name"></a></p>
    </div>
</li>

<script type="text/javascript">
$( function () {
    $('.a-units').madoneUnits();

    $('#pages').nestedSortable(
   	    $.extend({
            stop: function(event, ui){
                Storm.reorder( 'Model_Page', { id: {{ root.id }}, children: $('#pages').nestedSortable('toHierarchy') } );
            }
        }, Madone.nestedSortableOptions)
    );

    $( '.a-units .menu' ).click( function( e ) {
        Storm.toggle( Storm.buildPath( this ), Function.delegate( this, function ( data ) {
            if(data.menu) {
                $( this ).removeClass( 'menu_off' );
            }
            else {
                $( this ).addClass( 'menu_off' );
            }
        }));
    });

   	var pageForm = Object.create( Storm.Form ).extend( {
   		form: $( '#page-form' ),

   		onFillItem: function ( item, data ) {
   			item.attr( 'id', 'a-unit-' + data.id );
   			item.find('.editlink').attr('href', "/admin/" + data.module + "/" + data.id);
   			item.find('.directlink').attr('href', data.uri);
   		}
   	});

    // Новая страница
    $(".create-page").click( function ( e ) {
        Object.create( pageForm ).extend( {
            object:		'Model_Page',
            formPlace:	$( '.createFormPlace' ),
            item:		$( '#page-template' ),
            itemPlace:	$( '#pages' )
        } ).start();
   	} );

    // Редактирование страницы
    $( '.a-units .edit' ).bind( 'click', function( event ) {
        Object.create( pageForm ).extend( {
            object:	Storm.buildPath( this ),
            item:	$( this ).parents( '.a-unit-body' )
        } ).start();
    });
});
</script>